<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKER-Council Monitor</title>
    <style>
        :root {
            /* Modern Palette - Slate/Zinc inspired */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            
            --status-success-bg: #052e16;
            --status-success-text: #4ade80;
            
            --status-error-bg: #450a0a;
            --status-error-text: #f87171;
            
            --status-pending-bg: #451a03;
            --status-pending-text: #fbbf24;

            --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .layout {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; }
        h2 { margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 600; color: var(--text-main); }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: var(--primary-hover); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .stat-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .stat-value.error { color: var(--status-error-text); }

        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { 
            background: var(--bg-body); 
            padding: 1rem 1.5rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
        }
        td { 
            padding: 1rem 1.5rem; 
            border-top: 1px solid var(--border); 
            color: var(--text-main);
            font-size: 0.875rem;
        }
        tr:hover td { background: var(--bg-hover); cursor: pointer; }

        code { 
            font-family: var(--font-mono); 
            font-size: 0.8em; 
            background: rgba(0,0,0,0.3); 
            padding: 2px 4px; 
            border-radius: 4px; 
            color: var(--primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-success { background: var(--status-success-bg); color: var(--status-success-text); border: 1px solid rgba(74, 222, 128, 0.2); }
        .status-error { background: var(--status-error-bg); color: var(--status-error-text); border: 1px solid rgba(248, 113, 113, 0.2); }
        .status-pending { background: var(--status-pending-bg); color: var(--status-pending-text); border: 1px solid rgba(251, 191, 36, 0.2); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-body);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .close-icon { cursor: pointer; color: var(--text-muted); font-size: 1.5rem; line-height: 1; transition: color 0.2s; }
        .close-icon:hover { color: var(--text-main); }

        .detail-group { margin-bottom: 2rem; }
        .detail-label { 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            margin-bottom: 0.5rem; 
        }

        pre {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            color: #d1d5db;
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
        }

        .trace-item {
            border: 1px solid var(--border);
            background: var(--bg-body);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .trace-header {
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trace-tool { font-weight: 600; color: var(--primary); font-family: var(--font-mono); }
        .trace-duration { color: var(--text-muted); font-size: 0.75rem; }
        
        .trace-body { padding: 1rem; }
        .trace-section-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 600; }
        .trace-content { 
            background: rgba(0,0,0,0.3); 
            padding: 0.5rem; 
            border-radius: 0.25rem; 
            font-family: var(--font-mono); 
            font-size: 0.8rem; 
            white-space: pre-wrap; 
            color: #cbd5e1;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }
        .trace-content.error { background: rgba(69, 10, 10, 0.5); color: #fca5a5; }

        /* Modern UI Additions */
        .btn-danger { background: var(--status-error-bg); color: var(--status-error-text); border: 1px solid rgba(248, 113, 113, 0.2); }
        .btn-danger:hover { background: rgba(69, 10, 10, 0.8); border-color: var(--status-error-text); }
        
        .btn-secondary { background: var(--bg-hover); color: var(--text-main); }
        .btn-secondary:hover { background: var(--border); }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
            backdrop-filter: blur(8px);
        }
        .toast.success { border-left: 4px solid var(--status-success-text); }
        .toast.error { border-left: 4px solid var(--status-error-text); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Settings Modal */
        .settings-form { display: flex; flex-direction: column; gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-label { font-size: 0.875rem; color: var(--text-muted); font-weight: 500; }
        .form-input {
            background: var(--bg-body);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.375rem;
            color: var(--text-main);
            font-family: inherit;
            width: 100%;
        }
        .form-input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Animation & Interactive */
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); border-color: var(--primary); }
        
        button.loading { opacity: 0.7; pointer-events: none; cursor: not-allowed; }
        
    </style>
</head>
<body>
    <div class="layout">
        <header>
            <div style="display:flex; align-items:center; gap:12px;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                <div>
                    <h1>MAKER-Council <span style="color:var(--text-muted); font-weight:400;">Monitor</span></h1>
                    <div id="last-updated" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Last updated: Never</div>
                </div>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="openSettings()" class="btn-secondary" title="Settings" id="btn-settings">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button onclick="confirmClearData()" class="btn-danger" title="Clear Database" id="btn-clear">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
                <button onclick="manualRefresh()" id="btn-refresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px; vertical-align:middle;"><path d="M23 4v6h-6M1 20v-6h6"/></svg>
                    Refresh
                </button>
            </div>
        </header>

        <div class="stats-grid" id="stats">
            <!-- Stats -->
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Request ID</th>
                        <th>Tool / Intent</th>
                        <th>Status</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="requests-table">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal-overlay" id="details-modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <span class="close-icon" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close-icon" onclick="closeSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-form">
                    <div class="form-group">
                        <label class="form-label">Maximum Entries to Save</label>
                        <input type="number" id="setting-entry-limit" class="form-input" value="1000" min="100" max="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Auto-refresh Interval</label>
                        <select id="setting-refresh-interval" class="form-input">
                            <option value="5000">5 seconds</option>
                            <option value="10000">10 seconds</option>
                            <option value="30000">30 seconds</option>
                            <option value="60000">1 minute</option>
                            <option value="0">Disabled</option>
                        </select>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:1rem;">
                        <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                        <button onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // State
        let settings = {
            entryLimit: 1000,
            autoRefreshInterval: 5000
        };
        let refreshTimer = null;
        let lastUpdated = null;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            fetchData();
            startAutoRefresh();
        });

        // ==========================================
        // Data Fetching
        // ==========================================
        async function fetchData() {
            try {
                const btn = document.getElementById('btn-refresh');
                if (btn) btn.classList.add('loading');

                const [statsRes, reqRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/requests')
                ]);
                
                if (!statsRes.ok || !reqRes.ok) throw new Error('API Error');

                const stats = await statsRes.json();
                const requests = await reqRes.json();
                
                renderStats(stats);
                renderRequests(requests);
                
                updateLastUpdated();
            } catch (e) {
                console.error('Fetch error:', e);
                showToast('Failed to fetch data', 'error');
            } finally {
                const btn = document.getElementById('btn-refresh');
                if (btn) btn.classList.remove('loading');
            }
        }

        async function manualRefresh() {
            await fetchData();
            showToast('Dashboard refreshed');
        }

        function updateLastUpdated() {
            lastUpdated = new Date();
            const el = document.getElementById('last-updated');
            if (el) el.textContent = `Last updated: ${lastUpdated.toLocaleTimeString()}`;
        }

        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            if (settings.autoRefreshInterval > 0) {
                refreshTimer = setInterval(fetchData, settings.autoRefreshInterval);
            }
        }

        // ==========================================
        // Rendering
        // ==========================================
        function renderStats(stats) {
            document.getElementById('stats').innerHTML = `
                <div class="card">
                    <div class="stat-label">TOTAL REQUESTS</div>
                    <div class="stat-value">${stats.total}</div>
                </div>
                <div class="card">
                    <div class="stat-label">FAILED</div>
                    <div class="stat-value error">${stats.errors}</div>
                </div>
                <div class="card">
                    <div class="stat-label">AVG LATENCY</div>
                    <div class="stat-value">${stats.avgDuration.toFixed(0)}<span style="font-size:1rem;color:var(--text-muted);margin-left:4px">ms</span></div>
                </div>
                <div class="card">
                    <div class="stat-label">ACTIVE TOOLS</div>
                    <div class="stat-value">${stats.toolStats ? stats.toolStats.length : 0}</div>
                </div>
            `;
        }

        function renderRequests(requests) {
            if (!requests || requests.length === 0) {
                document.getElementById('requests-table').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center; padding: 3rem; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                            <div style="font-size: 1.1rem; font-weight: 500; color: var(--text-main);">No data available yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">The dashboard is ready and waiting for MCP server activity.</div>
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('requests-table').innerHTML = requests.map(req => `
                <tr onclick="showDetails('${req.id}')">
                    <td style="color:var(--text-muted)">${new Date(req.timestamp).toLocaleTimeString()}</td>
                    <td><code>${req.id.slice(0, 8)}</code></td>
                    <td style="font-weight:500;color:var(--primary)">${req.tool_name}</td>
                    <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                    <td style="font-family:var(--font-mono)">${req.duration_ms}ms</td>
                </tr>
            `).join('');
        }

        async function showDetails(id) {
            try {
                const res = await fetch(`/api/requests/${id}`);
                const data = await res.json();
                const req = data.request;
                const resp = data.response;
                const logs = data.logs;
                const tool_calls = data.tool_calls || [];

                const html = `
                    <div class="detail-group">
                        <div class="detail-label">Prompt</div>
                        <pre style="white-space:pre-wrap">${req.prompt}</pre>
                    </div>

                    ${tool_calls.length > 0 ? `
                    <div class="detail-group">
                        <div class="detail-label">Agent Execution Trace (${tool_calls.length} steps)</div>
                        <div style="display:flex;flex-direction:column;gap:0;">
                            ${tool_calls.map(tc => `
                                <div class="trace-item">
                                    <div class="trace-header">
                                        <span class="trace-tool">${tc.tool_name}</span>
                                        <span class="trace-duration">${tc.duration_ms}ms</span>
                                    </div>
                                    <div class="trace-body">
                                        <div class="trace-section-label">Input Args</div>
                                        <div class="trace-content">${formatJSON(tc.arguments)}</div>
                                        
                                        <div class="trace-section-label">Output</div>
                                        <div class="trace-content ${tc.error ? 'error' : ''}">${tc.error || tc.output || '(no output)'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="detail-group">
                            <div class="detail-label">Configuration</div>
                            <pre>${formatJSON(req.config)}</pre>
                        </div>
                        ${resp ? `
                        <div class="detail-group">
                            <div class="detail-label">Result Metadata</div>
                            <pre>${formatJSON(resp.metadata)}</pre>
                        </div>
                        ` : ''}
                    </div>

                    ${resp ? `
                    <div class="detail-group">
                        <div class="detail-label">Final Response</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; border-color:var(--primary);">${resp.result}</pre>
                    </div>
                    ` : ''}
                `;

                document.getElementById('modal-body').innerHTML = html;
                document.getElementById('details-modal').classList.add('active');
            } catch (e) {
                console.error(e);
                showToast('Failed to load details', 'error');
            }
        }

        function closeModal() {
            document.getElementById('details-modal').classList.remove('active');
        }

        // ==========================================
        // Settings & Management
        // ==========================================
        function openSettings() {
            document.getElementById('setting-entry-limit').value = settings.entryLimit;
            document.getElementById('setting-refresh-interval').value = settings.autoRefreshInterval;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function saveSettings() {
            const limit = parseInt(document.getElementById('setting-entry-limit').value);
            const interval = parseInt(document.getElementById('setting-refresh-interval').value);

            settings = {
                entryLimit: limit,
                autoRefreshInterval: interval
            };

            // Save to LocalStorage
            localStorage.setItem('maker_monitor_settings', JSON.stringify(settings));

            // Sync with backend (fire and forget for now if backend doesn't exist)
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (e) {
                console.warn('Backend settings sync failed (endpoint might not exist yet)');
            }

            closeSettings();
            startAutoRefresh();
            showToast('Settings saved');
        }

        async function loadSettings() {
            // Try localStorage first
            const stored = localStorage.getItem('maker_monitor_settings');
            if (stored) {
                settings = JSON.parse(stored);
            } else {
                // Try backend
                try {
                    const res = await fetch('/api/settings');
                    if (res.ok) {
                        settings = await res.json();
                        localStorage.setItem('maker_monitor_settings', JSON.stringify(settings));
                    }
                } catch (e) {
                    console.warn('Backend settings load failed');
                }
            }
        }

        async function confirmClearData() {
            if (confirm('Are you sure you want to clear all monitoring data? This action cannot be undone.')) {
                try {
                    const btn = document.getElementById('btn-clear');
                    btn.classList.add('loading');
                    
                    const res = await fetch('/api/data', { method: 'DELETE' });
                    
                    if (res.ok) {
                        showToast('Database cleared successfully');
                        fetchData();
                    } else {
                        throw new Error('Server returned error');
                    }
                } catch (e) {
                    showToast('Failed to clear database (API might not exist yet)', 'error');
                } finally {
                    const btn = document.getElementById('btn-clear');
                    btn.classList.remove('loading');
                }
            }
        }

        // ==========================================
        // Utilities
        // ==========================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            
            toast.innerHTML = `
                <span style="font-size: 1.25rem;">${icon}</span>
                <span style="font-weight: 500;">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatJSON(str) {
            if (!str) return 'null';
            try {
                const obj = typeof str === 'string' ? JSON.parse(str) : str;
                return JSON.stringify(obj, null, 2);
            } catch {
                return str;
            }
        }
    </script>
</body>
</html>